<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <style>
    <style>
      body {
        color: #5c617b;
      }
      .events_label {
        font-weight: bold;
        font-size: 15px;
        margin-right: 8px;
        margin-left: 8px;
        display: inline-block;
      }
      .date_select.inline.block, .event_select_left.inline.block, .event_select_right.inline.block, .prop_select.inline.block, .right-arrow, #add, #leftAdd, #rightAdd, #addProps, #addLeftProps, #addRightProps {
        display: inline-block;
        vertical-align: middle;
      }
      .event_select_left.inline.block, .event_select_right.inline.block {
        max-width: 200px;
        margin: 10px 0;
      }
      .dates, .options {
        margin-bottom: 10px;
      }
      .right-arrow {
        background: url(//cdn.mxpnl.com/cache/0a836ac387413f8cfa0ac97c5618c8bf/images/reports/arrow-dropshadow.png) no-repeat;
        background-position: 0 0;
        height: 10px;
        width: 10px;
        margin: 10px;
      }
      #add, #leftAdd, #rightAdd, #addProps, #addLeftProps, #addRightProps {
        background: url(https://cdn.mxpnl.com/cache/db85795727e3c42d2865a215cd85876a/images/reports/funnels3/new_row_spritesheet.png);
        width: 30px;
        height: 30px;
        cursor: pointer;
        position: relative;
        margin-left: 15px;
      }
      #run {
        clear:both;
        vertical-align: 1px;
        padding: 6px 12px;
        background-color: #61adf0;
        background-image: -webkit-linear-gradient(#6ab5f2,#53a0ee);
        background-image: linear-gradient(#6ab5f2,#53a0ee);
        box-shadow: inset 0 1px 1px #77bdf4,0 2px 2px -1px rgba(0,0,0,0.2);
        text-transform: uppercase;
        border: 1px solid #4d93d7;
        color: #fff;
        text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
        border-radius: 3px;
        cursor: pointer;
        font-weight: bold;
      }
      #run {
        max-width: 26px;
      }
      .alert {
        display: none;
        position: fixed;
        margin: 0 auto;
        left: 0;
        right: 0;
        top: 30%;
        margin-top: -75px;
        z-index: 20;
        background-color: #fbfbfb;
        border: 1px solid #c4c9d8;
        padding: 20px;
        width: 300px;
        min-height: 150px;
        border-radius: 5px;
      }
      .alert-title {
        text-transform: uppercase;
        font-weight: 600;
        margin: 15px;
      }
      .alert-content {
        margin: 15px;
        line-height: 25px;
      }
      .alert-ok {
        display: inline-block;
        margin-left: 10px;
        position: absolute;
        bottom: 15px;
        right: 35px;
      }
      /*.funnelGraph {
        display: inline-block;
      }
      #funnelLeft, #funnelRight {
        position: center;
        margin: auto;
      }*/
    </style>
    <div class="mixpanel-platform-section">
      <div class="dates">
        <div class="events_label">Left Funnel Date Range:</div>
        <div id="leftDates" class="date_select inline block"></div>
        <div class="events_label">Right Funnel Date Range:</div>
        <div id="rightDates" class="date_select inline block"></div>
      </div>
      <div id="leftEvents">
        <div class="events_label">Left Funnel Steps:</div>
        <div id="leftAdd"></div>
      </div>
      <div id="rightEvents">
        <div class="events_label">Right Funnel Steps:</div>
        <div id="rightAdd"></div>
      </div>
      <br>
      <div id="props">
        <div class="events_label">Property Filters:</div>
        <div id="addProps"></div>
      </div>
      <br>
      <div id="leftProps">
        <div class="events_label">Left Funnel Property Filters:</div>
        <div id="addLeftProps"></div>
      </div>
      <br>
      <div id="rightProps">
        <div class="events_label">Right Funnel Property Filters:</div>
        <div id="addRightProps"></div>
      </div>
      <br>
      <div class="options">
        <div class="events_label">Totals or Uniques:</div>
        <div id="queryType" class="date_select inline block"></div>
        <div class="events_label">Bar or Line Graph:</div>
        <div id="graphType" class="date_select inline block"></div>
        <div class="events_label">Units:</div>
        <div id="unitType" class="date_select inline block"></div>
      </div>
      <br>
      <div id="run">RUN</div>
      <br>
      <div id="graphs">
        <table>
          <tr>
            <td width="400"><div class="events_label" id="left_universe"></div></td>
            <td width="100"></td>
            <td width="400"><div class="events_label" id="right_universe"></div></td>
          </tr>
          <tr>
            <td width="400"><div class="funnelGraph" id="funnelLeft"></div><div class="funnelGraph" id="funnelLeftBar"></div></td>
            <td width="100"></td>
            <td width="400"><div class="funnelGraph" id="funnelRight"></div><div class="funnelGraph" id="funnelRightBar"></div></td>
          </tr>
        </table>
      </div>
      <br>
      <div>
        <div id="table"></div>
      </div>
    </div>
    
    <script>

      MP.api.setCredentials('7a66766fb54b8f77ba03ada28b0bfb1f');

      // add elements
      var leftEventList = [];
      var rightEventList = [];
      var propList = [];
      var valueList = [];
      var leftPropList = [];
      var leftValueList = [];
      var rightPropList = [];
      var rightValueList = [];
      var $leftEvents = $('#leftEvents');
      var $leftAdd = $('#leftEvents').find('#leftAdd');
      var $rightEvents = $('#rightEvents');
      var $rightAdd = $('#rightEvents').find('#rightAdd');
      var $props = $('#props');
      var $addProps = $('#props').find('#addProps');
      var $leftProps = $('#leftProps');
      var $addLeftProps = $('#leftProps').find('#addLeftProps');
      var $rightProps = $('#rightProps');
      var $addRightProps = $('#rightProps').find('#addRightProps');
      $('#leftDates').MPDatepicker();
      $('#rightDates').MPDatepicker();
      var queryOptions = {
        items: [
          {label: 'Unique', value: 'unique'},
          {label: 'Total', value: 'total'},
        ]
      };
      $('#queryType').MPSelect(queryOptions);
      var graphOptions = {
        items: [
          {label: 'Bar', value: 'bar'},
          {label: 'Line', value: 'line'},
        ]
      };
      $('#graphType').MPSelect(graphOptions);
      var unitOptions = {
        items: [
          {label: 'Day', value: 'day'},
          {label: 'Week', value: 'week'},
          {label: 'Month', value: 'month'},
        ]
      };
      $('#unitType').MPSelect(unitOptions);


      function addLeftEvent(i) {
        if (i > 0) {
          $('<div class="right-arrow"></div>').insertBefore($leftAdd);
        }
        var eventSelect = $('<div class="event_select_left inline block" id="' + i + '"></div>').insertBefore($leftAdd).MPEventSelect();
      }

      function addRightEvent(i) {
        if (i > 0) {
          $('<div class="right-arrow"></div>').insertBefore($rightAdd);
        }
        var eventSelect = $('<div class="event_select_right inline block" id="' + i + '"></div>').insertBefore($rightAdd).MPEventSelect();
      }

      function addProp(i) {
        if (i > 0){
          //$('<div class="right-arrow"></div>').insertBefore($addProps);
          var valueBuffer = $('<div class="events_label"> AND </div>').insertBefore($addProps);
        }

        var propSelect = $('<div class="prop_select inline block prop_selector" id="' + i + '"></div>').insertBefore($addProps).MPPropertySelect();
        propSelect.MPPropertySelect('setEvent', eventList[i]);
      }

      function addValue(i) {
        $('<div class="right-arrow"></div>').insertBefore($addProps);

        MP.api.propertyValues(eventList[i], propList[i]).done(function(results) {
          var options = {};
          options.items = [];
          _.each(results.values(), function(item) {
            options.items.push({label: item, value: item});
          });

          var valueSelect = $('<div class="prop_select inline block value_selector" id="' + i + '"></div>').insertBefore($addProps).MPSelect(options);
        });
      }

      function addLeftProp(i) {
        if (i > 0){
          var valueLeftBuffer = $('<div class="events_label"> AND </div>').insertBefore($addLeftProps);
        }

        var propLeftSelect = $('<div class="prop_select inline block prop_selector_left" id="' + i + '"></div>').insertBefore($addLeftProps).MPPropertySelect();
        propLeftSelect.MPPropertySelect('setEvent', eventList[eventList.length-1]);
      }

      function addLeftValue(i) {
        $('<div class="right-arrow"></div>').insertBefore($addLeftProps);

        MP.api.propertyValues(eventList[eventList.length-1], leftPropList[i]).done(function(results) {
          var options = {};
          options.items = [];
          _.each(results.values(), function(item) {
            options.items.push({label: item, value: item});
          });

          var valueLeftSelect = $('<div class="prop_select inline block value_selector_left" id="' + i + '"></div>').insertBefore($addLeftProps).MPSelect(options);
        });
      }

      function addRightProp(i) {
        if (i > 0){
          var valueRightBuffer = $('<div class="events_label"> AND </div>').insertBefore($addRightProps);
        }

        var propRightSelect = $('<div class="prop_select inline block prop_selector_right" id="' + i + '"></div>').insertBefore($addRightProps).MPPropertySelect();
        propRightSelect.MPPropertySelect('setEvent', eventList[eventList.length-1]);
      }

      function addRightValue(i) {
        $('<div class="right-arrow"></div>').insertBefore($addRightProps);

        MP.api.propertyValues(eventList[eventList.length-1], rightPropList[i]).done(function(results) {
          var options = {};
          options.items = [];
          _.each(results.values(), function(item) {
            options.items.push({label: item, value: item});
          });

          var valueRightSelect = $('<div class="prop_select inline block value_selector_right" id="' + i + '"></div>').insertBefore($addRightProps).MPSelect(options);
        });
      }

      // error alerts
      function error(message) {
        var alert = $('<div class="alert"><div class="alert-title">Error</div><div class="alert-content">' + message + '</div><div class="alert-ok">OK</div></div>');
        alert.appendTo('body').fadeIn(200);
      }
      // close alerts
      $('body').on('click', '.alert-ok', function() {
          $('.alert').remove();
      });

      $(document).ready(function() {
        addLeftEvent(0);
        addRightEvent(0);
      });

      $('#leftAdd').on('click', function() {
        var numEvents = $('.event_select_left').length;
        addLeftEvent(numEvents);
      });

      $('#rightAdd').on('click', function() {
        var numEvents = $('.event_select_right').length;
        addRightEvent(numEvents);
      });

      $('#addProps').on('click', function() {
        var numProps = $('.prop_selector').length;

        var events = [];
        for (var i = 0, j = $('.event_select').length; i < j; i++) {
          var eventName = $($('.event_select')[i]).val();
          if (eventName != null) {
            events.push(eventName);
          }
        }
        eventList = events;
        console.log('event list: ' + eventList);

        var props = [];
        for (var i = 0, j = $('.prop_selector').length; i < j; i++) {
          var propName = $($('.prop_selector')[i]).val();
          if (propName != null) {
            props.push(propName);
          }
        }
        propList = props;
        console.log('props list: ' + propList);

        var values = [];
        for (var i = 0, j = $('.value_selector').length; i < j; i++) {
          var valueName = $($('.value_selector')[i]).val();
          if (valueName != null) {
            values.push(valueName);
          }
        }
        valueList = values;
        console.log('values list: ' + valueList);

        if(numProps > 0) {
          if(propList.length < numProps) { 
            //error handling
            error('Please select a property key before proceeding');
          } else {
            if(valueList.length < propList.length) {
              addValue(numProps-1);
            } else {
              addProp(numProps);
            }
          }
        } else {
          addProp(0);
        }
      });

      $('#addLeftProps').on('click', function() {
        var numProps = $('.prop_selector_left').length;

        var events = [];
        for (var i = 0, j = $('.event_select_left').length; i < j; i++) {
          var eventName = $($('.event_select_left')[i]).val();
          if (eventName != null) {
            events.push(eventName);
          }
        }
        leftEventList = events;
        console.log('event list: ' + leftEventList);

        var leftProps = [];
        for (var i = 0, j = $('.prop_selector_left').length; i < j; i++) {
          var leftPropName = $($('.prop_selector_left')[i]).val();
          if (leftPropName != null) {
            leftProps.push(leftPropName);
          }
        }
        leftPropList = leftProps;
        console.log('left props list: ' + leftPropList);

        var leftValues = [];
        for (var i = 0, j = $('.value_selector_left').length; i < j; i++) {
          var valueLeftName = $($('.value_selector_left')[i]).val();
          if (valueLeftName != null) {
            leftValues.push(valueLeftName);
          }
        }
        leftValueList = leftValues;
        console.log('left values list: ' + leftValueList);

        if(numProps > 0) {
          if(leftPropList.length < numProps) { 
            //error handling
            error('Please select a property key before proceeding');
          } else {
            if(leftValueList.length < leftPropList.length) {
              addLeftValue(numProps-1);
            } else {
              addLeftProp(numProps);
            }
          }
        } else {
          addLeftProp(0);
        }
      });

      $('#addRightProps').on('click', function() {
        var numProps = $('.prop_selector_right').length;

        var events = [];
        for (var i = 0, j = $('.event_select_right').length; i < j; i++) {
          var eventName = $($('.event_select_right')[i]).val();
          if (eventName != null) {
            events.push(eventName);
          }
        }
        rightEventList = events;
        console.log('event list: ' + rightEventList);

        var rightProps = [];
        for (var i = 0, j = $('.prop_selector_right').length; i < j; i++) {
          var rightPropName = $($('.prop_selector_right')[i]).val();
          if (rightPropName != null) {
            rightProps.push(rightPropName);
          }
        }
        rightPropList = rightProps;
        console.log('right props list: ' + rightPropList);

        var rightValues = [];
        for (var i = 0, j = $('.value_selector_right').length; i < j; i++) {
          var valueRightName = $($('.value_selector_right')[i]).val();
          if (valueRightName != null) {
            rightValues.push(valueRightName);
          }
        }
        rightValueList = rightValues;
        console.log('right values list: ' + rightValueList);

        if(numProps > 0) {
          if(rightPropList.length < numProps) { 
            //error handling
            error('Please select a property key before proceeding');
          } else {
            if(rightValueList.length < rightPropList.length) {
              addRightValue(numProps-1);
            } else {
              addRightProp(numProps);
            }
          }
        } else {
          addRightProp(0);
        }
      });

      //to do
      //consolidate the methods for grabbing event, prop, value lists

      // run the query
      $('#run').on('click', function() {

        var leftEvents = [];
        for (var i = 0, j = $('.event_select_left').length; i < j; i++) {
          var eventName = $($('.event_select_left')[i]).val();
          if (eventName != null) {
            leftEvents.push(eventName);
          }
        }
        leftEventList = leftEvents;
        console.log('event list: ' + leftEventList);

        var rightEvents = [];
        for (var i = 0, j = $('.event_select_right').length; i < j; i++) {
          var eventName = $($('.event_select_right')[i]).val();
          if (eventName != null) {
            rightEvents.push(eventName);
          }
        }
        rightEventList = rightEvents;
        console.log('event list: ' + rightEventList);

        if(leftEventList.length < 2 || rightEventList.length < 2) { 
          error('Please select more than one event before proceeding');
        } else {
          var props = [];
          for (var i = 0, j = $('.prop_selector').length; i < j; i++) {
            var propName = $($('.prop_selector')[i]).val();
            if (propName != null) {
              props.push(propName);
            }
          }
          propList = props;
          console.log('props list: ' + propList);

          var values = [];
          for (var i = 0, j = $('.value_selector').length; i < j; i++) {
            var valueName = $($('.value_selector')[i]).val();
            if (valueName != null) {
              values.push(valueName);
            }
          }
          valueList = values;
          console.log('values list: ' + valueList);
          if(valueList.length !== propList.length) {
            error('Please select a property value before proceeding');
          } else {

            var leftProps = [];
            for (var i = 0, j = $('.prop_selector_left').length; i < j; i++) {
              var leftPropName = $($('.prop_selector_left')[i]).val();
              if (leftPropName != null) {
                leftProps.push(leftPropName);
              }
            }
            leftPropList = leftProps;
            console.log('left props list: ' + leftPropList);

            var leftValues = [];
            for (var i = 0, j = $('.value_selector_left').length; i < j; i++) {
              var valueLeftName = $($('.value_selector_left')[i]).val();
              if (valueLeftName != null) {
                leftValues.push(valueLeftName);
              }
            }
            leftValueList = leftValues;
            console.log('left values list: ' + leftValueList);

            if(leftValueList.length !== leftPropList.length) {
              error('Please select a left property value before proceeding');
            } else {
              var rightProps = [];
              for (var i = 0, j = $('.prop_selector_right').length; i < j; i++) {
                var rightPropName = $($('.prop_selector_right')[i]).val();
                if (rightPropName != null) {
                  rightProps.push(rightPropName);
                }
              }
              rightPropList = rightProps;
              console.log('right props list: ' + rightPropList);

              var rightValues = [];
              for (var i = 0, j = $('.value_selector_right').length; i < j; i++) {
                var valueRightName = $($('.value_selector_right')[i]).val();
                if (valueRightName != null) {
                  rightValues.push(valueRightName);
                }
              }
              rightValueList = rightValues;
              console.log('right values list: ' + rightValueList);
              if(rightValueList.length !== rightPropList.length) {
                error('Please select a right property value before proceeding');
              } else {
              runQuery();
              } 
            }
          }
        }        
      });

      var runQuery = function() {

        // to do:
        // add in customization of length and length unit params

        $('#table').empty();
        $("#funnelLeft").empty();
        $("#funnelRight").empty();
        $("#funnelLeftBar").empty();
        $("#funnelRightBar").empty();

        var selector = '';
        for(i=0; i<propList.length; i++) {
          selector = selector + '(string(properties["' + propList[i] + '"]) == "' + valueList[i] + '") and'
        }

        var leftSelector = selector;
        for(i=0; i<leftPropList.length; i++) {
          if(i < leftPropList.length - 1) {
            leftSelector = leftSelector + '(string(properties["' + leftPropList[i] + '"]) == "' + leftValueList[i] + '") and'
          } else {
            if(leftPropList.length == leftValueList.length) {
              leftSelector = leftSelector + '(string(properties["' + leftPropList[i] + '"]) == "' + leftValueList[i] + '")'
            } else {
              leftSelector = leftSelector.substring(0, leftSelector.length - 3);
            }
          }
        }
        if(leftPropList.length == 0 && selector.length > 0) {
          leftSelector = selector.substring(0, selector.length - 4);
        }

        var rightSelector = selector;
        for(i=0; i<rightPropList.length; i++) {
          if(i < rightPropList.length - 1) {
            rightSelector = rightSelector + '(string(properties["' + rightPropList[i] + '"]) == "' + rightValueList[i] + '") and'
          } else {
            if(rightPropList.length == rightValueList.length) {
              rightSelector = rightSelector + '(string(properties["' + rightPropList[i] + '"]) == "' + rightValueList[i] + '")'
            } else {
              rightSelector = rightSelector.substring(0, rightSelector.length - 3);
            }
          }
        }
        if(rightPropList.length == 0 && selector.length > 0) {
          rightSelector = selector.substring(0, selector.length - 4);
        }

        var funnelEventsLeft = [];
        _.each(leftEventList, function(event) {
          if(leftSelector !== '') {
            funnelEventsLeft.push({"event": event, "selector": leftSelector});
          } else {
            funnelEventsLeft.push({"event": event});
          }
        })
        console.log('left funnel events to query:');
        console.log(funnelEventsLeft);

        var leftParams = {
          to: $('#leftDates').val().to,
          from: $('#leftDates').val().from,
          events: funnelEventsLeft,
          type: $('#queryType').val(),
          graph: $('#graphType').val(),
          unit: $('#unitType').val(),
        };

        console.log('left funnel params to query:');
        console.log(leftParams);

        var funnelEventsRight = [];
        _.each(rightEventList, function(event) {
          if(rightSelector !== '') {  
            funnelEventsRight.push({"event": event, "selector": rightSelector});
          } else {
            funnelEventsRight.push({"event": event});
          }
        })
        console.log('right funnel events to query:');
        console.log(funnelEventsRight);

        var rightParams = {
          to: $('#rightDates').val().to,
          from: $('#rightDates').val().from,
          events: funnelEventsRight,
          type: $('#queryType').val(),
          graph: $('#graphType').val(),
          unit: $('#unitType').val(),
        };

        console.log('right funnel params to query:');
        console.log(rightParams);

        var scriptCount = $('#jql-count').html();

        MP.api.jql(scriptCount, leftParams).done(function(leftUniqueResults) {
          var uniquesLeft = {};
          var leftTotal = 0;
          _.each(leftUniqueResults, function(item) {
            uniquesLeft[item.Date] = item.Count;
            leftTotal += item.Count;
          })
          console.log(uniquesLeft);
          $('#left_universe').text('Active Users: ' + leftTotal);
          MP.api.jql(scriptCount, rightParams).done(function(rightUniqueResults) {
            var uniquesRight = {};
            var rightTotal = 0;
            _.each(rightUniqueResults, function(item) {
              uniquesRight[item.Date] = item.Count;
              rightTotal += item.Count;
            })
            console.log(uniquesRight);
            $('#right_universe').text('Active Users: ' + rightTotal);

              var script = $('#jql-funnel').html();

              MP.api.jql(script, leftParams).done(function(leftResults) {
                var keys = Object.keys(leftResults[0]);
                var leftData = {};
                if($('#graphType').val() == 'line') {
                  $("#funnelLeft").MPChart({chartType: 'line'});
                  leftData['Conversion Rate'] = {};
                  for(i=0; i<keys.length; i++) {
                    if(!isNaN(keys[i].charAt(0))) {
                      leftData['Conversion Rate'][keys[i]] = leftResults[0][keys[i]] / uniquesLeft[keys[i]];
                    }
                    //to do -- add divide by dau wau mau
                  }
                  $("#funnelLeft").MPChart('setData', leftData);
                  console.log(leftData);
                }
                else {
                  $("#funnelLeftBar").MPChart({chartType: 'bar'});
                  for(i=0; i<keys.length; i++) {
                    if(isNaN(keys[i].charAt(0))) {
                      leftData[keys[i]] = leftResults[0][keys[i]];
                    }
                  }
                  $("#funnelLeftBar").MPChart('setData', leftData);
                  console.log(leftData);
                }
                
                MP.api.jql(script, rightParams).done(function(rightResults) {
                  var keys = Object.keys(rightResults[0]);
                  var rightData = {};
                  if($('#graphType').val() == 'line') {
                    $("#funnelRight").MPChart({chartType: 'line'});
                    rightData['Conversion Rate'] = {};
                    for(i=0; i<keys.length; i++) {
                      if(!isNaN(keys[i].charAt(0))) {
                        rightData['Conversion Rate'][keys[i]] = rightResults[0][keys[i]] / uniquesRight[keys[i]];
                      }
                      //to do -- add divide by dau wau mau
                    }
                    $("#funnelRight").MPChart('setData', rightData);
                    console.log(rightData);
                  }
                  else {
                    $("#funnelRightBar").MPChart({chartType: 'bar'});
                    for(i=0; i<keys.length; i++) {
                      if(isNaN(keys[i].charAt(0))) {
                        rightData[keys[i]] = rightResults[0][keys[i]];
                      }
                    }
                    $("#funnelRightBar").MPChart('setData', rightData);
                    console.log(rightData);
                  }
                });
              });

          });

        });

        

        //to do
        //make the queries not absolutely depend on one another (this is slow in UI)

        

        /*MP.api.query('/api/2.0/arb_funnels/', leftParams).done(function(results) {
          var leftResults = {};
          var dates = Object.keys(results['data']);
          console.log(results['data']);
          for(j=0; j<dates.length; j++) {
            for(i=0; i<leftEventList.length; i++) {
              leftResults[leftEventList[i]] += results['data'][dates[j]]['steps'][i]['count']
              if(isNaN(leftResults[leftEventList[i]])){
                leftResults[leftEventList[i]] = results['data'][dates[j]]['steps'][i]['count'];
              }
            }
          }
          var leftGraph = $("#funnelLeft").MPChart({chartType: 'bar'});
          leftGraph.MPChart('setData', leftResults);
          console.log(leftResults);

          MP.api.query('/api/2.0/arb_funnels/', rightParams).done(function(results) {
            var rightResults = {};
            var dates = Object.keys(results['data']);
            console.log(results['data']);
            for(j=0; j<dates.length; j++) {
              for(i=0; i<rightEventList.length; i++) {
                rightResults[rightEventList[i]] += results['data'][dates[j]]['steps'][i]['count']
                if(isNaN(rightResults[rightEventList[i]])){
                  rightResults[rightEventList[i]] = results['data'][dates[j]]['steps'][i]['count'];
                }
              }
            }
            var rightGraph = $("#funnelRight").MPChart({chartType: 'bar'});
            rightGraph.MPChart('setData', rightResults);
            console.log(rightResults);

            leftKeysSorted = Object.keys(leftResults).sort(function(a,b){return leftResults[b]-leftResults[a]});
            rightKeysSorted = Object.keys(rightResults).sort(function(a,b){return rightResults[b]-rightResults[a]});

            stepsMin = Math.max(leftKeysSorted.length, rightKeysSorted.length) - Math.abs(leftKeysSorted.length - rightKeysSorted.length);
            table = {};
            table[0] = ['Step', 'Event Count Left', 'Event Count Right', 'Percent Change']
            for(i=1; i<stepsMin+1; i++) {
              table[i] = [];
              table[i].push(i);
              table[i].push(leftResults[leftKeysSorted[i-1]]);
              table[i].push(rightResults[rightKeysSorted[i-1]]);
              table[i].push((((rightResults[rightKeysSorted[i-1]] - leftResults[leftKeysSorted[i-1]]) / leftResults[leftKeysSorted[i-1]]) * 100).toFixed(2).toString() + '%');
            }
            table[stepsMin+1] = [];
            table[stepsMin+1].push('Overall')
            table[stepsMin+1].push((leftResults[leftKeysSorted[stepsMin-1]] / leftResults[leftKeysSorted[0]] * 100).toFixed(2).toString() + '%');
            table[stepsMin+1].push((rightResults[rightKeysSorted[stepsMin-1]] / rightResults[rightKeysSorted[0]] * 100).toFixed(2).toString() + '%');
            table[stepsMin+1].push((rightResults[rightKeysSorted[stepsMin-1]] / rightResults[rightKeysSorted[0]] * 100 - leftResults[leftKeysSorted[stepsMin-1]] / leftResults[leftKeysSorted[0]] * 100).toFixed(2).toString() + '%');

            console.log(table);
            $('#table').append('<table id="resultsTable" width="100%">');
            for(i=0; i<stepsMin+2; i++) {
              $('#table').append('<tr>');
              for(j=0; j<table[i].length; j++) {
                $('#table').append('<td width="25%" align="center" style="font-weight: bold;font-size: 15px; text-align:center; border:3px solid #000000;">' + table[i][j] + '</td>');
              }
              $('#table').append('</tr>');
            }
            $('#table').append('</table>');
          });
        });*/
      }

    </script>

    <script id='jql-count'>
      function main() {
        return Events({
          from_date: params.from.substring(0,10),
          to_date:   params.to.substring(0,10)
        })
        .groupByUser([function(event) { return findDay(params.unit, params.from, event.time) }], mixpanel.reducer.count())
        .groupBy([function(item) { return item.key[1]; }], mixpanel.reducer.count())
        .map(function(item) {
          var obj = {};
          return {
            'Date': item.key[0],
            'Count': item.value
          }
        })
      }

      function findDay(unit, from, time) {
        var find = new Date(time);
        var current = new Date(from);
        if(unit == 'day') {
          var seconds = 1000 * 60 * 60 * 24;
        } else if(unit == 'week') {
          var seconds = 1000 * 60 * 60 * 24 * 7;
        } else if(unit == 'month') {
          var seconds = 1000 * 60 * 60 * 24 * 30;
          var month = true;
        }
        while(current < find) {
          if(month === true) {
            if(current.getMonth() == 12) {
              if(new Date(current.getFullYear() + 1, 1, 1) < find) {
                current = new Date(current.getFullYear() + 1, 1, 1);
              } else {
                break;
              }
            } else {
              if(new Date(current.getFullYear(), current.getMonth() + 1, 1) < find) {
                current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
              } else {
                break;
              }
            }
          } else {
            if(new Date(current.getTime() + seconds) < find) {
              current = new Date(current.getTime() + seconds);
            } else {
              break;
            }
          }
        }
        return current.toISOString().substring(0,10);
      }
    </script>

    <script id='jql-funnel'>
      function main() {
        return Events({
          from_date: params.from.substring(0,10),
          to_date:   params.to.substring(0,10),
          event_selectors: params.events
        })
        .groupByUser(function(state, events) {
          state = state || getDays(params.unit, params.to, params.from, params.events);
          _.each(events, function(event) {
            for(i=0; i<params.events.length; i++) {
              // any middle step
              if(i !== 0 && i !== params.events.length-1 && event.name == params.events[i]['event']) {
                if(state[params.events[i]['event']] == state[params.events[i-1]['event']] - 1) { 
                  if(params.type == 'unique') {
                    state[event.name] = 1;
                  } else {
                    state[event.name] += 1;
                  }
                }
              } else if(i === 0 && event.name == params.events[i]['event'] && state[params.events[0]['event']] == state[params.events[params.events.length-1]['event']]) { // first step
                if(params.type == 'unique') {
                  state[event.name] = 1;
                } else {
                  state[event.name] += 1;
                }
                state.time = event.time;
              } else if(i == params.events.length-1 && event.name == params.events[i]['event']) { // final step
                if(params.type == 'unique') {
                  if(state[event.name] === 0 && state[params.events[i-1]['event']] == 1) {
                    var recordDay = findDay(params.unit, params.from, state.time);
                    state[recordDay] = 1;
                    state[event.name] = 1;
                  }
                } else {
                  if(state[params.events[i]['event']] == state[params.events[i-1]['event']] - 1) {
                    var recordDay = findDay(params.unit, params.from, state.time);
                    state[recordDay] += 1;
                    state[event.name] += 1;
                  }
                }
              }
            }
          })
          return state;
        })
        .map(function(item) {
          var obj = {};
          var events = [];
          for(i=0; i<params.events.length; i++) {
            events.push(params.events[i]['event']);
          }
          var keys = Object.keys(item.value);
          for(i=0; i<keys.length; i++) {
            if(keys[i] !== 'time') {
              obj[keys[i]] = item.value[keys[i]];
            }
          }
          return obj;
        })
        .reduce(mixpanel.reducer.object_merge());
      }

      function getDays(unit, to, from, events) {
        var obj = {};
        var start = new Date(from);
        var end = new Date(new Date(to).getTime() + 60 * 60 * 24 * 1000);
        var current = start;
        if(unit == 'day') {
          var seconds = 1000 * 60 * 60 * 24;
        } else if(unit == 'week') {
          var seconds = 1000 * 60 * 60 * 24 * 7;
        } else if(unit == 'month') {
          var month = true;
        }
        while(current < end) {
          if(month === true) {
            obj[current.toISOString().substring(0,10)] = 0;
            if(current.getMonth() == 12) {
              current = new Date(current.getFullYear() + 1, 1, 1);
            } else {
              current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
            }
          } else {
            obj[current.toISOString().substring(0,10)] = 0;
            current = new Date(current.getTime() + seconds);
          }
        }
        for(i=0; i<events.length; i++) { 
          obj[events[i]['event']] = 0;
        }
        obj['time'] = 0;
        return obj;
      }

      function findDay(unit, from, time) {
        var find = new Date(time);
        var current = new Date(from);
        if(unit == 'day') {
          var seconds = 1000 * 60 * 60 * 24;
        } else if(unit == 'week') {
          var seconds = 1000 * 60 * 60 * 24 * 7;
        } else if(unit == 'month') {
          var seconds = 1000 * 60 * 60 * 24 * 30;
          var month = true;
        }
        while(current < find) {
          if(month === true) {
            if(current.getMonth() == 12) {
              if(new Date(current.getFullYear() + 1, 1, 1) < find) {
                current = new Date(current.getFullYear() + 1, 1, 1);
              } else {
                break;
              }
            } else {
              if(new Date(current.getFullYear(), current.getMonth() + 1, 1) < find) {
                current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
              } else {
                break;
              }
            }
          } else {
            if(new Date(current.getTime() + seconds) < find) {
              current = new Date(current.getTime() + seconds);
            } else {
              break;
            }
          }
        }
        return current.toISOString().substring(0,10);
      }
    </script>

  </body>
</html>
